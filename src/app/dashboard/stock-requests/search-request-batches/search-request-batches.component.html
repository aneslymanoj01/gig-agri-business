<div class="search-request-batches-page">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="breadcrumb">
        <span class="breadcrumb-item">Dashboard</span>
        <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
        <span class="breadcrumb-item" (click)="goBack()">Stock Requests</span>
        <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
        <span class="breadcrumb-item active">Search Batches</span>
      </div>
      <h1 class="page-title">
        <mat-icon class="title-icon">search</mat-icon>
        Search Request Batches
      </h1>
      <p class="page-subtitle">Find and manage stock request batches</p>
    </div>
  </div>

  <!-- Content Section -->
  <div class="content-section">
    <div class="content-container">
      
      <!-- Search Filters -->
      <div class="search-filters">
        <mat-form-field appearance="outline">
          <mat-label>Search by ID</mat-label>
          <input matInput [(ngModel)]="searchFilters.id" (keyup.enter)="onSearch()" placeholder="Batch ID">
          <mat-icon matSuffix>tag</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Distributor ID</mat-label>
          <input matInput [(ngModel)]="searchFilters.distributorId" (keyup.enter)="onSearch()" placeholder="Distributor ID" type="number">
          <mat-icon matSuffix>business</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <select matNativeControl [(ngModel)]="searchFilters.status">
            <option value="">All statuses</option>
            <option value="PENDING">Pending</option>
            <option value="APPROVED">Approved</option>
            <option value="REJECTED">Rejected</option>
          </select>
        </mat-form-field>

        <div class="search-actions">
          <button mat-raised-button color="primary" (click)="onSearch()" [disabled]="isLoading">
            <mat-icon>search</mat-icon>
            Search
          </button>
          <button mat-stroked-button (click)="onClear()" [disabled]="isLoading">
            <mat-icon>clear</mat-icon>
            Clear
          </button>
        </div>
      </div>

      <!-- Actions Bar -->
      <div class="actions-bar">
        <button mat-raised-button color="primary" (click)="onRefresh()" [disabled]="isLoading">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
        <span class="results-count" *ngIf="!isLoading">
          Showing {{ requestBatches.length }} of {{ totalElements }} batches
        </span>
      </div>

      <!-- Section Title -->
      <div class="section-header">
        <h3>Request Batches List</h3>
        <div class="section-divider"></div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading request batches...</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && requestBatches.length === 0" class="empty-state">
        <mat-icon class="empty-icon">inventory</mat-icon>
        <h3>No Request Batches Found</h3>
        <p>No request batches match your search criteria or there are no batches in the system.</p>
      </div>

      <!-- Data Table -->
      <div *ngIf="!isLoading && requestBatches.length > 0" class="table-container">
        <table mat-table [dataSource]="requestBatches" class="request-batches-table">
          
          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>Batch ID</th>
            <td mat-cell *matCellDef="let batch">
              {{ batch.id }}
            </td>
          </ng-container>

          <!-- Distributor ID Column -->
          <ng-container matColumnDef="distributorId">
            <th mat-header-cell *matHeaderCellDef>Distributor ID</th>
            <td mat-cell *matCellDef="let batch">
              {{ batch.distributorId }}
            </td>
          </ng-container>

          <!-- Priority Column -->
          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef>Priority</th>
            <td mat-cell *matCellDef="let batch">
              <span class="priority-badge" [class]="'priority-' + batch.priority.toLowerCase()">
                {{ batch.priority }}
              </span>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let batch">
              <span class="status-badge" [class]="'status-' + batch.status.toLowerCase()">
                {{ batch.status }}
              </span>
            </td>
          </ng-container>

          <!-- Requested At Column -->
          <ng-container matColumnDef="requestedAt">
            <th mat-header-cell *matHeaderCellDef>Requested At</th>
            <td mat-cell *matCellDef="let batch">
              {{ batch.requestedAt | date:'short' }}
            </td>
          </ng-container>

          <!-- Rejection Reason Column -->
          <ng-container matColumnDef="rejectionReason">
            <th mat-header-cell *matHeaderCellDef>Rejection Reason</th>
            <td mat-cell *matCellDef="let batch">
              {{ batch.rejectionReason || '-' }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let batch">
              <button mat-stroked-button (click)="viewBatchDetails(batch)" class="view-btn">
                <mat-icon>visibility</mat-icon>
                View
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="batch-row"></tr>
        </table>
      </div>

      <!-- Pagination -->
      <div *ngIf="!isLoading && requestBatches.length > 0 && totalPages > 1" class="pagination-container">
        <div class="pagination-info">
          <span>Page {{ currentPage + 1 }} of {{ totalPages }}</span>
        </div>
        <div class="pagination-controls">
          <button mat-icon-button [disabled]="isFirst" (click)="onPageChange(0)" matTooltip="First Page">
            <mat-icon>first_page</mat-icon>
          </button>
          <button mat-icon-button [disabled]="isFirst" (click)="onPageChange(currentPage - 1)" matTooltip="Previous Page">
            <mat-icon>chevron_left</mat-icon>
          </button>
          
          <div class="page-numbers">
            <button 
              *ngFor="let page of getPageNumbers()" 
              mat-button 
              [class.active]="page === currentPage"
              (click)="onPageChange(page)">
              {{ page + 1 }}
            </button>
          </div>
          
          <button mat-icon-button [disabled]="isLast" (click)="onPageChange(currentPage + 1)" matTooltip="Next Page">
            <mat-icon>chevron_right</mat-icon>
          </button>
          <button mat-icon-button [disabled]="isLast" (click)="onPageChange(totalPages - 1)" matTooltip="Last Page">
            <mat-icon>last_page</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Batch Details Modal -->
  <div *ngIf="selectedBatch" class="modal-overlay" (click)="closeBatchDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Batch Details - {{ selectedBatch.id }}</h3>
        <button mat-icon-button (click)="closeBatchDetails()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="batch-info">
          <div class="info-item">
            <span class="label">Distributor ID:</span>
            <span class="value">{{ selectedBatch.distributorId }}</span>
          </div>
          <div class="info-item">
            <span class="label">Priority:</span>
            <span class="value priority-badge" [class]="'priority-' + selectedBatch.priority.toLowerCase()">
              {{ selectedBatch.priority }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Status:</span>
            <span class="value status-badge" [class]="'status-' + selectedBatch.status.toLowerCase()">
              {{ selectedBatch.status }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Notes:</span>
            <span class="value">{{ selectedBatch.notes || '-' }}</span>
          </div>
        </div>

        <div class="products-section">
          <h4>Products</h4>
          <div class="products-table">
            <table>
              <thead>
                <tr>
                  <th>Product ID</th>
                  <th>Product Name</th>
                  <th>Quantity</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of selectedBatch.items">
                  <td>{{ item.productId }}</td>
                  <td>{{ item.productName }}</td>
                  <td>{{ item.quantity }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
